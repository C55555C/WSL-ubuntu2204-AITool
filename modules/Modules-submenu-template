#!/bin/bash
set -e

echo "🚀 安装 Tailscale（Docker 用户空间网络模式）"
read -p "⚠️ 确认要继续安装 Tailscale 吗？(y/n): " confirm
if [[ "$confirm" != "y" ]]; then
  echo "❎ 已取消安装操作"
  exit 0
fi

TS_AUTHKEY="tskey-auth-kKLSAFo5Z511CNTRL-aTPjXaKHZyDaMy6TedZLyDyodf4JDqQVc"
TS_HOSTNAME="anythingllml"
TS_SOCKS_PORT=1077

echo "📁 创建挂载目录..."
mkdir -p ~/tailscale-docker/data

echo "🧹 停止并删除已有 tailscale 容器（如有）..."
docker rm -f tailscale 2>/dev/null || true

echo "🐳 启动 tailscale 容器（userspace-networking 模式）..."
docker run -d \
  --name tailscale \
  --restart unless-stopped \
  --network=host \
  --cap-add=NET_ADMIN \
  -v ~/tailscale-docker/data:/var/lib/tailscale \
  tailscale/tailscale \
  tailscaled --tun=userspace-networking --socks5-server=localhost:$TS_SOCKS_PORT

sleep 2
echo "🔐 登录 tailscale 网络（authkey + hostname）..."
docker exec -it tailscale tailscale up --authkey="$TS_AUTHKEY" --hostname="$TS_HOSTNAME"

echo "✅ tailscale 启动完成！"
echo "🧪 当前状态："
docker exec -it tailscale tailscale status

echo "🌐 如启用 SOCKS5，可使用如下命令测试连接："
echo "curl --socks5 localhost:$TS_SOCKS_PORT https://ifconfig.me"
read -p "按回车继续..."
