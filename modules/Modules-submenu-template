#!/bin/bash
set -e

echo "ğŸš€ å®‰è£… Tailscaleï¼ˆDocker ç”¨æˆ·ç©ºé—´ç½‘ç»œæ¨¡å¼ï¼‰"
read -p "âš ï¸ ç¡®è®¤è¦ç»§ç»­å®‰è£… Tailscale å—ï¼Ÿ(y/n): " confirm
if [[ "$confirm" != "y" ]]; then
  echo "â å·²å–æ¶ˆå®‰è£…æ“ä½œ"
  exit 0
fi

TS_AUTHKEY="tskey-auth-kKLSAFo5Z511CNTRL-aTPjXaKHZyDaMy6TedZLyDyodf4JDqQVc"
TS_HOSTNAME="anythingllml"
TS_SOCKS_PORT=1077

echo "ğŸ“ åˆ›å»ºæŒ‚è½½ç›®å½•..."
mkdir -p ~/tailscale-docker/data

echo "ğŸ§¹ åœæ­¢å¹¶åˆ é™¤å·²æœ‰ tailscale å®¹å™¨ï¼ˆå¦‚æœ‰ï¼‰..."
docker rm -f tailscale 2>/dev/null || true

echo "ğŸ³ å¯åŠ¨ tailscale å®¹å™¨ï¼ˆuserspace-networking æ¨¡å¼ï¼‰..."
docker run -d \
  --name tailscale \
  --restart unless-stopped \
  --network=host \
  --cap-add=NET_ADMIN \
  -v ~/tailscale-docker/data:/var/lib/tailscale \
  tailscale/tailscale \
  tailscaled --tun=userspace-networking --socks5-server=localhost:$TS_SOCKS_PORT

sleep 2
echo "ğŸ” ç™»å½• tailscale ç½‘ç»œï¼ˆauthkey + hostnameï¼‰..."
docker exec -it tailscale tailscale up --authkey="$TS_AUTHKEY" --hostname="$TS_HOSTNAME"

echo "âœ… tailscale å¯åŠ¨å®Œæˆï¼"
echo "ğŸ§ª å½“å‰çŠ¶æ€ï¼š"
docker exec -it tailscale tailscale status

echo "ğŸŒ å¦‚å¯ç”¨ SOCKS5ï¼Œå¯ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤æµ‹è¯•è¿æ¥ï¼š"
echo "curl --socks5 localhost:$TS_SOCKS_PORT https://ifconfig.me"
read -p "æŒ‰å›è½¦ç»§ç»­..."
