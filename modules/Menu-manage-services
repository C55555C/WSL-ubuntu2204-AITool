#!/bin/bash

submenu_tailscale() {
  while true; do
    clear
    echo "===== 📡 Tailscale 管理 ====="
    echo " 1. 检查更新"
    echo " 2. 登录状态"
    echo " 3. 查看网络 (ifconfig)"
    echo " 4. 查看公网映射 (Funnel)"
    echo " 5. tailscale 状态"
    echo " 99. 卸载"
    echo " 0. 返回"
    echo ""
    read -p "请选择操作编号: " choice
    case "$choice" in
      1) docker exec -it tailscale tailscale version; read -p "按回车继续..." ;;
      2) docker exec -it tailscale tailscale status; read -p "按回车继续..." ;;
      3) ifconfig; read -p "按回车继续..." ;;
      4) docker exec -it tailscale tailscale funnel list; read -p "按回车继续..." ;;
      5) docker exec -it tailscale tailscale status; read -p "按回车继续..." ;;
      99)
        read -p "⚠️ 确认要卸载 tailscale 吗？(y/n): " confirm
        if [[ "$confirm" == "y" ]]; then
          docker rm -f tailscale && rm -rf ~/tailscale-docker
          echo "✅ 已卸载 tailscale"
        else
          echo "❎ 已取消"
        fi
        read -p "按回车继续..."
        ;;
      0) break ;;
      *) echo "❌ 无效选项"; read ;;
    esac
  done
}

submenu_openwebui() {
  while true; do
    clear
    echo "===== 🌐 Open WebUI 管理 ====="
    echo " 1. 检查更新"
    echo " 2. 启动服务"
    echo " 3. 停止服务"
    echo " 4. 查看日志"
    echo " 99. 卸载"
    echo " 0. 返回"
    echo ""
    read -p "请选择操作编号: " choice
    case "$choice" in
      1) docker pull ghcr.io/open-webui/open-webui:main && echo "✅ 已更新"; read -p "按回车继续..." ;;
      2) docker start openwebui && echo "✅ 已启动 Open WebUI"; read -p "按回车继续..." ;;
      3) docker stop openwebui && echo "✅ 已停止 Open WebUI"; read -p "按回车继续..." ;;
      4) docker logs -f openwebui ;;
      99)
        read -p "⚠️ 确认要卸载 Open WebUI 吗？(y/n): " confirm
        if [[ "$confirm" == "y" ]]; then
          docker stop openwebui && docker rm openwebui && docker volume rm openwebui-data
          echo "✅ Open WebUI 已卸载"
        else
          echo "❎ 已取消卸载"
        fi
        read -p "按回车继续..."
        ;;
      0) break ;;
      *) echo "❌ 无效选项，按回车重试..."; read ;;
    esac
  done
}

submenu_ollama() {
  while true; do
    clear
    echo "===== 🦙 Ollama 管理 ====="
    echo " 1. 检查更新"
    echo " 2. 服务状态"
    echo " 3. 停止服务"
    echo " 4. 重启服务"
    echo " 5. 服务日志"
    echo " 6. 拉取模型"
    echo " 7. 清理模型"
    echo " 8. 接口检查"
    echo " 99. 卸载"
    echo " 0. 返回"
    echo ""
    read -p "请选择操作编号: " choice
    case "$choice" in
      1) curl -fsSL https://ollama.com/install.sh | sh && echo "✅ 已更新 Ollama"; read -p "按回车继续..." ;;
      2) systemctl status ollama ; read -p "按回车继续..." ;;
      3) sudo systemctl stop ollama && echo "✅ 已停止"; read -p "按回车继续..." ;;
      4) sudo systemctl restart ollama && echo "✅ 已重启"; read -p "按回车继续..." ;;
      5) journalctl -u ollama -e -f ;;
      6) read -p "输入模型名称（如 llama3:latest）: " model; ollama pull "$model" ; read -p "按回车继续..." ;;
      7) ollama rm -a && echo "✅ 所有模型已清理"; read -p "按回车继续..." ;;
      8) curl http://localhost:11434/api/tags && echo "✅ 接口正常"; read -p "按回车继续..." ;;
      99)
        read -p "⚠️ 确认要卸载 Ollama 吗？(y/n): " confirm
        if [[ "$confirm" == "y" ]]; then
          sudo systemctl stop ollama && sudo rm -f /etc/systemd/system/ollama.service
          sudo systemctl daemon-reload
          sudo rm -rf ~/.ollama /usr/local/bin/ollama
          echo "✅ 已卸载 Ollama"
        else
          echo "❎ 已取消卸载"
        fi
        read -p "按回车继续..."
        ;;
      0) break ;;
      *) echo "❌ 无效选项，按回车重试..."; read ;;
    esac
  done
}

submenu_anythingllm() {
  while true; do
    clear
    echo "===== 📚 AnythingLLM 管理 ====="
    echo " 1. 检查更新"
    echo " 2. 启动服务"
    echo " 3. 停止服务"
    echo " 4. 修改配置"
    echo " 5. 清除缓存"
    echo " 99. 卸载"
    echo " 0. 返回"
    echo ""
    read -p "请选择操作编号: " choice
    case "$choice" in
      1) cd ~/anything-llm && git pull && echo "✅ 已更新"; read -p "按回车继续..." ;;
      2) cd ~/anything-llm && docker compose up -d && echo "✅ 启动完成"; read -p "按回车继续..." ;;
      3) cd ~/anything-llm && docker compose down && echo "✅ 已停止"; read -p "按回车继续..." ;;
      4) nano ~/anything-llm/.env ;;
      5) docker system prune -af && echo "✅ 清理完成"; read -p "按回车继续..." ;;
      99)
        read -p "⚠️ 确认要卸载 AnythingLLM 吗？(y/n): " confirm
        if [[ "$confirm" == "y" ]]; then
          cd ~ && rm -rf ~/anything-llm
          echo "✅ AnythingLLM 已卸载"
        else
          echo "❎ 已取消卸载"
        fi
        read -p "按回车继续..."
        ;;
      0) break ;;
      *) echo "❌ 无效选项，按回车重试..."; read ;;
    esac
  done
}
